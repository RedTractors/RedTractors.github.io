<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Red Tractors-Oxfam 2018 </title>

    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.5/angular.min.js" integrity="sha256-zBy1l2WBAh2vPF8rnjFMUXujsfkKjya0Jy5j6yKj0+Q=" crossorigin="anonymous"></script>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <script src="lines.js"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-104176150-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-104176150-2');
    </script>


    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        h3 {
            margin-top: 0;
            margin-bottom: 4px;
        }
        
        h5 {
            margin-top: 0;
            margin-bottom: 0;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        .markerRT {
            background-image: url('redTractor.png');
            background-size: cover;
            width: 50px;
            height: 50px;
            xxborder-radius: 50%;
            cursor: pointer;
        }
        
        .markerFinish {
            background-image: url('finish.png');
            background-size: cover;
            width: 50px;
            height: 50px;
            xxborder-radius: 50%;
            cursor: pointer;
        }
        
        .distanceBox {
            position: absolute;
            bottom: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.562);
            z-index: 1000;
            padding: 10px;
        }
    </style>
</head>




<body ng-app="RedTractorsApp">
    <div ng-controller="RedTractorsController" class='distanceBox'>
        <div ng-hide="setup.setup.notReady">
            <h3> Distance: {{setup.setup.distance}} km</h3>
            <h3> WalkingTime: {{setup.setup.walktime}} </h3>
            <h3> Time Since Last Point: {{setup.setup.timeSinceLastCheckpointString}}</h3>
        </div>
        <div ng-show="setup.setup.notReady" style="color:orange">
            <h3> Not Started Yet</h3>
        </div>

        <h5> Data Updated: {{setup.setup.scriptLastRunAt}}</h5>
        </h1>
    </div>

    <div id='map'></div>



    <script>
        var map;

        var addLine = function(key, json, color) {
            map.addLayer({
                "id": key,
                "type": "line",
                "source": {
                    "type": "geojson",
                    "data": json
                },
                "layout": {
                    "line-join": "round",
                    "line-cap": "round"
                },
                "paint": {
                    "line-color": color,
                    "line-width": 10,
                    "line-opacity": .6,
                }
            });
        }

        angular.module('RedTractorsApp', [])
            .controller('RedTractorsController', function($scope, $http, $log, $interval) {

                $scope.setup = {"setup":{"notReady":false,"distance":5.83,"secondsFromLastPoint":4046.1370000839233,"timeSinceLastCheckpoint":{"string":"1h ,7m ,26s","hours":1,"minutes":7,"seconds":26},"timeSinceLastCheckpointString":"12:54:41","walktime":"2h ,21s","scriptLastRunAt":"14:02:08"},"lastPoint":[145.383042,-37.798547],"geojsonTeamPoints":{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Point","coordinates":[145.383042,-37.798547]},"properties":{"name":"team","title":"team"}}]},"geoJsonLine":{"type":"Feature","geometry":{"type":"LineString","coordinates":[[145.411482,-37.824767,276],[145.407981,-37.825187,261],[145.406621,-37.824571,248],[145.405739,-37.824395,246],[145.405627,-37.824832,237],[145.405906,-37.825794,222],[145.405205,-37.825565,225],[145.40472,-37.825153,222],[145.404411,-37.825156,222],[145.405957,-37.825808,221],[145.404411,-37.825451,227],[145.40443,-37.824946,226],[145.405077,-37.825477,220],[145.405797,-37.825659,226],[145.405924,-37.825818,227],[145.405817,-37.825829,223],[145.405522,-37.825559,224],[145.404726,-37.825342,218],[145.404421,-37.824849,221],[145.404018,-37.824681,219],[145.403082,-37.823614,221],[145.402354,-37.82361,227],[145.401874,-37.824135,226],[145.401214,-37.824184,228],[145.40138,-37.823638,246],[145.401298,-37.822297,225],[145.401539,-37.821451,244],[145.401151,-37.820602,237],[145.401241,-37.820184,247],[145.401058,-37.819576,243],[145.401273,-37.818982,249],[145.401897,-37.818296,245],[145.402119,-37.816298,230],[145.401969,-37.816038,216],[145.402001,-37.814672,231],[145.401706,-37.813424,228],[145.401737,-37.812879,227],[145.401332,-37.811874,233],[145.400928,-37.811573,231],[145.399129,-37.811415,217],[145.397783,-37.811054,208],[145.396831,-37.811116,214],[145.395623,-37.810418,205],[145.395277,-37.810147,210],[145.393819,-37.807942,191],[145.392212,-37.805128,217],[145.391118,-37.804239,199],[145.390736,-37.803044,213],[145.39046,-37.802731,217],[145.389954,-37.802357,218],[145.388658,-37.802237,213],[145.387764,-37.801848,205],[145.386875,-37.801853,192],[145.386094,-37.802406,187],[145.385885,-37.802363,179],[145.385566,-37.801581,195],[145.384824,-37.800682,204],[145.384463,-37.799736,215],[145.383822,-37.798884,221],[145.383042,-37.798547,199]]},"properties":{}}};

                mapboxgl.accessToken = 'pk.eyJ1IjoiYWFyb25zaW1zIiwiYSI6ImNqN2Z0NjVkYjExNHkyd28yNnc5cXhjNWgifQ.cgZZrzDKR2B8wX9TBXJ_kw';
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v9',
                    center: $scope.setup.lastPoint,
                    zoom: 15
                });

                map.on('load', function() {
                    map.addControl(new mapboxgl.NavigationControl());
                    map.addSource('theWalkLine', {
                        type: 'geojson',
                        data: $scope.setup.geoJsonLine
                    });

                    $scope.updateData = function(map) {

                        $http.get("setup.json?" + Math.random()).then(function(response) {
                            try {
                                $scope.setup = response.data;
                                //$log.log("data loaded");
                                $scope.updateMapData(map);
                                //$log.log("data updated");
                            } catch (error) {
                                $log.log("error loading data", error);
                            }

                        });

                    }



                    $scope.updateMapData = function(map) {
                        try {
                            if ($scope.TeamMarker) {
                                $scope.TeamMarker.remove();
                            }

                            map.getSource('theWalkLine').setData($scope.setup.geoJsonLine);
                            //map.getSource('theTeam').setData($scope.setup.geojsonTeamPoints);

                            var geojson = $scope.setup.geojsonTeamPoints;
                            geojson.features.forEach(function(marker) {
                                var el = document.createElement('div');
                                el.className = 'markerRT';
                                $scope.TeamMarker = new mapboxgl.Marker(el)
                                    .setLngLat(marker.geometry.coordinates)
                                    .addTo(map);
                            });
                            map.flyTo({
                                center: $scope.setup.lastPoint
                            });
                        } catch (error) {
                            $log.log("error updating data", error);
                        }
                    }
                    $scope.updateMapData(map)
                    map.addLayer({
                        "id": "route2",
                        "type": "line",
                        "source": 'theWalkLine',
                        "layout": {
                            "line-join": "round",
                            "line-cap": "round"
                        },
                        "paint": {
                            "line-color": "black",
                            "line-width": 7
                        }
                    });
                    map.addLayer({
                        "id": "route1",
                        "type": "line",
                        "source": 'theWalkLine',
                        "layout": {
                            "line-join": "round",
                            "line-cap": "round"
                        },
                        "paint": {
                            "line-color": "red",
                            "line-width": 2
                        }
                    });


                    addLine("section5", section5, '#898cff');
                    addLine("section6", section6, '#ffdc89');
                    addLine("section7", section7, '#f5a26f');
                    addLine("section8", section8, '#ed6d79');

                    /*    */
                    var finishLinePoint = {
                        "type": "FeatureCollection",
                        "features": [{
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [145.647024, -37.773042]
                            }
                        }]
                    };
                    finishLinePoint.features.forEach(function(marker) {
                        var el = document.createElement('div');
                        el.className = 'markerFinish';
                        new mapboxgl.Marker(el)
                            .setLngLat(marker.geometry.coordinates)
                            .addTo(map);
                    });



                    $scope.updateInterval = $interval(function() {
                        $scope.updateData(map);
                    }, 20000);


                    /*    */
                });

            });
    </script>
</body>

</html>
