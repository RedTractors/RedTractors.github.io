<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Red Tractors-Oxfam 2018 </title>

    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.5/angular.min.js" integrity="sha256-zBy1l2WBAh2vPF8rnjFMUXujsfkKjya0Jy5j6yKj0+Q=" crossorigin="anonymous"></script>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <script src="lines.js"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-104176150-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-104176150-2');
    </script>


    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        h3 {
            margin-top: 0;
            margin-bottom: 4px;
        }
        
        h5 {
            margin-top: 0;
            margin-bottom: 0;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        .markerRT {
            background-image: url('redTractor.png');
            background-size: cover;
            width: 50px;
            height: 50px;
            xxborder-radius: 50%;
            cursor: pointer;
        }
        
        .markerFinish {
            background-image: url('finish.png');
            background-size: cover;
            width: 50px;
            height: 50px;
            xxborder-radius: 50%;
            cursor: pointer;
        }
        
        .distanceBox {
            position: absolute;
            bottom: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.562);
            z-index: 1000;
            padding: 10px;
        }
    </style>
</head>




<body ng-app="RedTractorsApp">
    <div ng-controller="RedTractorsController" class='distanceBox'>
        <div ng-hide="setup.setup.notReady">
            <h3> Distance: {{setup.setup.distance}} km</h3>
            <h3> WalkingTime: {{setup.setup.walktime}} </h3>
            <h3> Time Since Last Point: {{setup.setup.timeSinceLastCheckpointString}}</h3>
        </div>
        <div ng-show="setup.setup.notReady" style="color:orange">
            <h3> Not Started Yet</h3>
        </div>

        <h5> Data Updated: {{setup.setup.scriptLastRunAt}}</h5>
        </h1>
    </div>

    <div id='map'></div>



    <script>
        var map;

        var addLine = function(key, json, color) {
            map.addLayer({
                "id": key,
                "type": "line",
                "source": {
                    "type": "geojson",
                    "data": json
                },
                "layout": {
                    "line-join": "round",
                    "line-cap": "round"
                },
                "paint": {
                    "line-color": color,
                    "line-width": 10,
                    "line-opacity": .6,
                }
            });
        }

        angular.module('RedTractorsApp', [])
            .controller('RedTractorsController', function($scope, $http, $log, $interval) {

                $scope.setup = {"setup":{"notReady":false,"distance":30.23,"secondsFromLastPoint":39.11500000953674,"timeSinceLastCheckpoint":{"string":"39s","seconds":39},"timeSinceLastCheckpointString":"20:05:02","walktime":"9h ,10m ,42s","scriptLastRunAt":"20:05:42"},"lastPoint":[145.607053,-37.779102],"geojsonTeamPoints":{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Point","coordinates":[145.607053,-37.779102]},"properties":{"name":"team","title":"team"}}]},"geoJsonLine":{"type":"Feature","geometry":{"type":"LineString","coordinates":[[145.411482,-37.824767,276],[145.407981,-37.825187,261],[145.406621,-37.824571,248],[145.405739,-37.824395,246],[145.405627,-37.824832,237],[145.405906,-37.825794,222],[145.405205,-37.825565,225],[145.40472,-37.825153,222],[145.404411,-37.825156,222],[145.405957,-37.825808,221],[145.404411,-37.825451,227],[145.40443,-37.824946,226],[145.405077,-37.825477,220],[145.405797,-37.825659,226],[145.405924,-37.825818,227],[145.405817,-37.825829,223],[145.405522,-37.825559,224],[145.404726,-37.825342,218],[145.404421,-37.824849,221],[145.404018,-37.824681,219],[145.403082,-37.823614,221],[145.402354,-37.82361,227],[145.401874,-37.824135,226],[145.401214,-37.824184,228],[145.40138,-37.823638,246],[145.401298,-37.822297,225],[145.401539,-37.821451,244],[145.401151,-37.820602,237],[145.401241,-37.820184,247],[145.401058,-37.819576,243],[145.401273,-37.818982,249],[145.401897,-37.818296,245],[145.402119,-37.816298,230],[145.401969,-37.816038,216],[145.402001,-37.814672,231],[145.401706,-37.813424,228],[145.401737,-37.812879,227],[145.401332,-37.811874,233],[145.400928,-37.811573,231],[145.399129,-37.811415,217],[145.397783,-37.811054,208],[145.396831,-37.811116,214],[145.395623,-37.810418,205],[145.395277,-37.810147,210],[145.393819,-37.807942,191],[145.392212,-37.805128,217],[145.391118,-37.804239,199],[145.390736,-37.803044,213],[145.39046,-37.802731,217],[145.389954,-37.802357,218],[145.388658,-37.802237,213],[145.387764,-37.801848,205],[145.386875,-37.801853,192],[145.386094,-37.802406,187],[145.385885,-37.802363,179],[145.385566,-37.801581,195],[145.384824,-37.800682,204],[145.384463,-37.799736,215],[145.383822,-37.798884,221],[145.383042,-37.798555,202],[145.502082,-37.757737,114],[145.50342,-37.758173,106],[145.504473,-37.759142,106],[145.505055,-37.760292,98],[145.505614,-37.762454,105],[145.506178,-37.763363,102],[145.506649,-37.76379,99],[145.508166,-37.764491,92],[145.51505,-37.764993,94],[145.516915,-37.765499,87],[145.517725,-37.766012,86],[145.518622,-37.766912,86],[145.523079,-37.772849,86],[145.526757,-37.774956,93],[145.528063,-37.775363,88],[145.530612,-37.775558,100],[145.531096,-37.776233,94],[145.531851,-37.7768,99],[145.532482,-37.776881],[145.53239,-37.776926,85],[145.532231,-37.776763],[145.532398,-37.776842],[145.532396,-37.776733],[145.53232,-37.777116,87],[145.53225,-37.776852],[145.532356,-37.77718,83],[145.532346,-37.776843],[145.53236,-37.777136,82],[145.532426,-37.776907],[145.532352,-37.777148,83],[145.532283,-37.776918],[145.532371,-37.777027,83],[145.532399,-37.776929],[145.532287,-37.776948,83],[145.53234,-37.777163,83],[145.532404,-37.776887],[145.532346,-37.777178,87],[145.531879,-37.77692,103],[145.532094,-37.776903,97],[145.532291,-37.777106,103],[145.532366,-37.776914],[145.532344,-37.777076,102],[145.532376,-37.776968],[145.53223,-37.777045],[145.532352,-37.777116,83],[145.532391,-37.776988],[145.532297,-37.776945],[145.532344,-37.777153,81],[145.532417,-37.776862],[145.532344,-37.777106,81],[145.532298,-37.777001],[145.532384,-37.777068,81],[145.532473,-37.776874],[145.532375,-37.777089,81],[145.532234,-37.776871],[145.532323,-37.777099,81],[145.532428,-37.776886],[145.532219,-37.776906],[145.532326,-37.777046,81],[145.532417,-37.776852],[145.532373,-37.777119,81],[145.532431,-37.776806],[145.53233,-37.77709,81],[145.5325,-37.776929],[145.532322,-37.776964,81],[145.532332,-37.777089,81],[145.532384,-37.776886],[145.532369,-37.777017,81],[145.532464,-37.77695],[145.532347,-37.777134,81],[145.532311,-37.776926],[145.532312,-37.777138,100],[145.532411,-37.776918],[145.53232,-37.777129,100],[145.5315,-37.776844,105],[145.531432,-37.776336,102],[145.530736,-37.775684,92],[145.530751,-37.775517,88],[145.53299,-37.775358,87],[145.535031,-37.774735,95],[145.536765,-37.773625,84],[145.540108,-37.770101,95],[145.54641,-37.765891,105],[145.547203,-37.765596,100],[145.549545,-37.765564,96],[145.550837,-37.765737,101],[145.551823,-37.766309,110],[145.553426,-37.767753,103],[145.554711,-37.768446,96],[145.555139,-37.768899,98],[145.555273,-37.769407,99],[145.555735,-37.770001,106],[145.556383,-37.770529,101],[145.56684,-37.774306,104],[145.567806,-37.774484,103],[145.570393,-37.77457,112],[145.572721,-37.775129,111],[145.574549,-37.775214,116],[145.578469,-37.77505,113],[145.579316,-37.774828,112],[145.580514,-37.774246,104],[145.581479,-37.774092,101],[145.582813,-37.774419,123],[145.583825,-37.775206,116],[145.584056,-37.775655,114],[145.585519,-37.776259,115],[145.587675,-37.776176,98],[145.589368,-37.775827,106],[145.592818,-37.776487,109],[145.594043,-37.776469,104],[145.596575,-37.77594,108],[145.598617,-37.776097,106],[145.602534,-37.776903,102],[145.603062,-37.776888,111],[145.605422,-37.777575,109],[145.606404,-37.778159,115],[145.607053,-37.779102,118]]},"properties":{}}};

                mapboxgl.accessToken = 'pk.eyJ1IjoiYWFyb25zaW1zIiwiYSI6ImNqN2Z0NjVkYjExNHkyd28yNnc5cXhjNWgifQ.cgZZrzDKR2B8wX9TBXJ_kw';
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v9',
                    center: $scope.setup.lastPoint,
                    zoom: 15
                });

                map.on('load', function() {
                    map.addControl(new mapboxgl.NavigationControl());
                    map.addSource('theWalkLine', {
                        type: 'geojson',
                        data: $scope.setup.geoJsonLine
                    });

                    $scope.updateData = function(map) {

                        $http.get("setup.json?" + Math.random()).then(function(response) {
                            try {
                                $scope.setup = response.data;
                                //$log.log("data loaded");
                                $scope.updateMapData(map);
                                //$log.log("data updated");
                            } catch (error) {
                                $log.log("error loading data", error);
                            }

                        });

                    }



                    $scope.updateMapData = function(map) {
                        try {
                            if ($scope.TeamMarker) {
                                $scope.TeamMarker.remove();
                            }

                            map.getSource('theWalkLine').setData($scope.setup.geoJsonLine);
                            //map.getSource('theTeam').setData($scope.setup.geojsonTeamPoints);

                            var geojson = $scope.setup.geojsonTeamPoints;
                            geojson.features.forEach(function(marker) {
                                var el = document.createElement('div');
                                el.className = 'markerRT';
                                $scope.TeamMarker = new mapboxgl.Marker(el)
                                    .setLngLat(marker.geometry.coordinates)
                                    .addTo(map);
                            });
                            map.flyTo({
                                center: $scope.setup.lastPoint
                            });
                        } catch (error) {
                            $log.log("error updating data", error);
                        }
                    }
                    $scope.updateMapData(map)
                    map.addLayer({
                        "id": "route2",
                        "type": "line",
                        "source": 'theWalkLine',
                        "layout": {
                            "line-join": "round",
                            "line-cap": "round"
                        },
                        "paint": {
                            "line-color": "black",
                            "line-width": 7
                        }
                    });
                    map.addLayer({
                        "id": "route1",
                        "type": "line",
                        "source": 'theWalkLine',
                        "layout": {
                            "line-join": "round",
                            "line-cap": "round"
                        },
                        "paint": {
                            "line-color": "red",
                            "line-width": 2
                        }
                    });


                    addLine("section5", section5, '#898cff');
                    addLine("section6", section6, '#ffdc89');
                    addLine("section7", section7, '#f5a26f');
                    addLine("section8", section8, '#ed6d79');

                    /*    */
                    var finishLinePoint = {
                        "type": "FeatureCollection",
                        "features": [{
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [145.647024, -37.773042]
                            }
                        }]
                    };
                    finishLinePoint.features.forEach(function(marker) {
                        var el = document.createElement('div');
                        el.className = 'markerFinish';
                        new mapboxgl.Marker(el)
                            .setLngLat(marker.geometry.coordinates)
                            .addTo(map);
                    });



                    $scope.updateInterval = $interval(function() {
                        $scope.updateData(map);
                    }, 20000);


                    /*    */
                });

            });
    </script>
</body>

</html>
