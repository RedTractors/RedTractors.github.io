<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Red Tractors-Oxfam 2018 </title>

    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.5/angular.min.js" integrity="sha256-zBy1l2WBAh2vPF8rnjFMUXujsfkKjya0Jy5j6yKj0+Q=" crossorigin="anonymous"></script>

    <script src="lines.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        h3 {
            margin-top: 0;
            margin-bottom: 4px;
        }
        
        h5 {
            margin-top: 0;
            margin-bottom: 0;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        .markerRT {
            background-image: url('redTractor.png');
            background-size: cover;
            width: 50px;
            height: 50px;
            xxborder-radius: 50%;
            cursor: pointer;
        }
        
        .markerFinish {
            background-image: url('finish.png');
            background-size: cover;
            width: 50px;
            height: 50px;
            xxborder-radius: 50%;
            cursor: pointer;
        }
        
        .distanceBox {
            position: absolute;
            bottom: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.562);
            z-index: 1000;
            padding: 10px;
        }
    </style>
</head>




<body ng-app="RedTractorsApp">
    <div ng-controller="RedTractorsController" class='distanceBox'>
        <h3> Distance: {{setup.setup.distance}} km</h3>
        <h3> WalkingTime: {{setup.setup.walktime}} </h3>
        <h3> Time Since Last Point: {{setup.setup.timeSinceLastCheckpointString}}</h3>
        <h5> Data Updated: {{setup.setup.scriptLastRunAt}}</h5>
        </h1>
    </div>

    <div id='map'></div>



    <script>
        var map;

        var addLine = function(key, json, color) {
            map.addLayer({
                "id": key,
                "type": "line",
                "source": {
                    "type": "geojson",
                    "data": json
                },
                "layout": {
                    "line-join": "round",
                    "line-cap": "round"
                },
                "paint": {
                    "line-color": color,
                    "line-width": 10,
                    "line-opacity": .6,
                }
            });
        }

        angular.module('RedTractorsApp', [])
            .controller('RedTractorsController', function($scope, $http, $log, $interval) {

                $scope.setup = {"setup":{"distance":24.45,"secondsFromLastPoint":31851.099999904633,"timeSinceLastCheckpoint":{"string":"8h ,50m ,51s","hours":8,"minutes":50,"seconds":51},"timeSinceLastCheckpointString":"13:03:45","walktime":"5h ,1s","scriptLastRunAt":"21:54:37"},"lastPoint":[144.964545,-37.820286],"geojsonTeamPoints":{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Point","coordinates":[144.964545,-37.820286]},"properties":{"name":"team","title":"team"}}]},"geoJsonLine":{"type":"Feature","geometry":{"type":"LineString","coordinates":[[144.966085,-37.743808,78],[144.9634,-37.760056,71],[144.963159,-37.760721,70],[144.963509,-37.820842],[144.963729,-37.820735,30],[144.963827,-37.820915],[144.963401,-37.820954],[144.963574,-37.821064,31],[144.963358,-37.821198],[144.964023,-37.821248,31],[144.963545,-37.820995],[144.963804,-37.820964],[144.963597,-37.820961],[144.963855,-37.8211,31],[144.963506,-37.82097],[144.96366,-37.821063,31],[144.963442,-37.820977],[144.963388,-37.821086],[144.963852,-37.821141,31],[144.963458,-37.820932],[144.963809,-37.82118,31],[144.963467,-37.820942],[144.963757,-37.821123,31],[144.96342,-37.821116],[144.963971,-37.821234,31],[144.963744,-37.821057],[144.963886,-37.821082,31],[144.964057,-37.821232,31],[144.963254,-37.821156],[144.963409,-37.820921],[144.963936,-37.821165,31],[144.96325,-37.820861],[144.963678,-37.820869],[144.963911,-37.821068,31],[144.96327,-37.820984],[144.96404,-37.821239,31],[144.963284,-37.820967],[144.963579,-37.820954],[144.963408,-37.820912],[144.963174,-37.821133],[144.964006,-37.821215,31],[144.963339,-37.821053],[144.963959,-37.821212,31],[144.963421,-37.820841],[144.963763,-37.821102],[144.963416,-37.821006],[144.963883,-37.821174,31],[144.963478,-37.821102],[144.963855,-37.821104,31],[144.963371,-37.820915],[144.963925,-37.821229,31],[144.963356,-37.821066],[144.963304,-37.820898],[144.963938,-37.821181,31],[144.963364,-37.820924],[144.963273,-37.8211],[144.963414,-37.820934],[144.964001,-37.821239,31],[144.963383,-37.821047],[144.963931,-37.82119,31],[144.963371,-37.820977],[144.963415,-37.82083],[144.963389,-37.82106],[144.96394,-37.821112,31],[144.963857,-37.82105,31],[144.963891,-37.821204,31],[144.963253,-37.821109],[144.963184,-37.821016],[144.963424,-37.821105],[144.963353,-37.820861],[144.963391,-37.821003],[144.96396,-37.821258,31],[144.963439,-37.820888],[144.964014,-37.821249,31],[144.963357,-37.821091],[144.963302,-37.82084],[144.963883,-37.821208,31],[144.963172,-37.820963],[144.963416,-37.820928],[144.963739,-37.821141,31],[144.963258,-37.821085],[144.963231,-37.820911],[144.963753,-37.821093,31],[144.963241,-37.821046],[144.964101,-37.821186,31],[144.963521,-37.82112],[144.964012,-37.821209,31],[144.963276,-37.820981],[144.963317,-37.820825],[144.96325,-37.821002],[144.9637,-37.821143,31],[144.963364,-37.820913],[144.963966,-37.821233,31],[144.963343,-37.820842],[144.963848,-37.821172,31],[144.963241,-37.820997],[144.963439,-37.820923],[144.963914,-37.821146,31],[144.963512,-37.820896],[144.963149,-37.821072],[144.963383,-37.820968],[144.963226,-37.821003],[144.963866,-37.82119,31],[144.963203,-37.820873],[144.963305,-37.820812],[144.963914,-37.821158,31],[144.96348,-37.820828],[144.96335,-37.820879],[144.963591,-37.821038],[144.963355,-37.82098],[144.963955,-37.821129],[144.963305,-37.820983],[144.963338,-37.820868],[144.963933,-37.821137,31],[144.963271,-37.821014],[144.963436,-37.820915],[144.963288,-37.821058],[144.963929,-37.821201,31],[144.96363,-37.820905],[144.963968,-37.821187,31],[144.96371,-37.821134,31],[144.964106,-37.82128,31],[144.963284,-37.820999],[144.963774,-37.821128,31],[144.963348,-37.82084],[144.963722,-37.821045,31],[144.963427,-37.82103],[144.963808,-37.821001],[144.963798,-37.821138,31],[144.963329,-37.821005],[144.963925,-37.821215,31],[144.963451,-37.820878],[144.963182,-37.820954],[144.964077,-37.82127,31],[144.963417,-37.820819],[144.964062,-37.821255,31],[144.963445,-37.821002],[144.963177,-37.821131],[144.964101,-37.821284,31],[144.963986,-37.821076,31],[144.964016,-37.82126,31],[144.963522,-37.8211],[144.963946,-37.821207,31],[144.963745,-37.821179,31],[144.963889,-37.821207,31],[144.963627,-37.820833],[144.964059,-37.821262,31],[144.963278,-37.82113],[144.963201,-37.82093],[144.963775,-37.821077,31],[144.96375,-37.820952],[144.96378,-37.82114,31],[144.964128,-37.82126,31],[144.963265,-37.821093],[144.963212,-37.820726],[144.963362,-37.820992],[144.963614,-37.821071],[144.963158,-37.820942],[144.96402,-37.821225,31],[144.963691,-37.821078,31],[144.963871,-37.8211],[144.963679,-37.820883],[144.963996,-37.821264,31],[144.963472,-37.82104],[144.963939,-37.82113,31],[144.963685,-37.821005],[144.96405,-37.821236,31],[144.963709,-37.820953],[144.9641,-37.821285,31],[144.963432,-37.820967],[144.963999,-37.821247,31],[144.96348,-37.821152],[144.963856,-37.821135,31],[144.963529,-37.821164],[144.963728,-37.821209,31],[144.963658,-37.821008,31],[144.963841,-37.821175,31],[144.963313,-37.821116],[144.964031,-37.821239,31],[144.963822,-37.821067,31],[144.963927,-37.821109,31],[144.963424,-37.821026],[144.964062,-37.821245,31],[144.963354,-37.820919],[144.963326,-37.821036],[144.963379,-37.820919],[144.963929,-37.820934],[144.964047,-37.821237,31],[144.963864,-37.821143,31],[144.964175,-37.821131,31],[144.964149,-37.821242,31],[144.963405,-37.820934],[144.963718,-37.821117,31],[144.963403,-37.82115],[144.963975,-37.821098,31],[144.96343,-37.820841],[144.964031,-37.82107],[144.963514,-37.820978,30],[144.963747,-37.820933],[144.963587,-37.820634,30],[144.963752,-37.820701,30],[144.9633,-37.820879],[144.963919,-37.821074],[144.96395,-37.821431],[144.962158,-37.821704,8],[144.962659,-37.821918],[144.963216,-37.821793,152],[144.963236,-37.821897,102],[144.962897,-37.821723,31],[144.963619,-37.82147],[144.963618,-37.821693,-3],[144.963899,-37.821359],[144.963679,-37.821612,-8],[144.963835,-37.821331,-6],[144.963426,-37.820946],[144.963531,-37.820753],[144.963757,-37.821119,31],[144.963264,-37.821043],[144.964006,-37.821249,31],[144.963353,-37.820993],[144.963701,-37.821087],[144.963464,-37.820995],[144.963223,-37.8211],[144.963961,-37.821226,31],[144.96336,-37.820891],[144.964032,-37.820953],[144.963969,-37.821121,31],[144.963515,-37.820972],[144.963654,-37.820878,29],[144.963183,-37.820979],[144.964105,-37.821303,31],[144.963427,-37.821029],[144.963726,-37.821056,31],[144.96386,-37.821166],[144.963205,-37.82106],[144.964005,-37.821263,31],[144.963298,-37.821049],[144.963398,-37.821091],[144.963395,-37.820735],[144.963594,-37.821126],[144.963277,-37.821158],[144.963842,-37.82103,31],[144.963327,-37.820987],[144.96379,-37.821082],[144.963353,-37.820972],[144.963759,-37.821098,31],[144.963388,-37.820887],[144.963494,-37.820724],[144.963315,-37.821118],[144.963359,-37.820895],[144.963556,-37.821035],[144.963836,-37.820974],[144.963571,-37.821024],[144.963872,-37.821161,31],[144.963465,-37.820963],[144.963841,-37.821006,31],[144.963336,-37.82113],[144.963424,-37.820856],[144.964029,-37.821228,31],[144.964076,-37.821049],[144.963557,-37.820938],[144.963893,-37.821156,31],[144.963717,-37.821193,31],[144.96405,-37.821271,31],[144.963357,-37.820942],[144.963302,-37.821071],[144.963951,-37.821245,31],[144.963504,-37.820973],[144.963367,-37.821122],[144.963985,-37.821185,31],[144.963728,-37.821027,31],[144.964107,-37.821297,31],[144.963401,-37.820937],[144.963754,-37.821057],[144.963533,-37.82101],[144.963642,-37.820996],[144.963101,-37.820938],[144.963705,-37.821123],[144.963386,-37.821091],[144.963416,-37.820927],[144.963958,-37.821224,31],[144.963233,-37.821003],[144.963176,-37.821132],[144.963473,-37.820893],[144.963329,-37.820904],[144.964015,-37.821209,31],[144.963387,-37.820898],[144.963297,-37.821142],[144.963909,-37.821233,31],[144.963391,-37.821022],[144.964107,-37.821297,31],[144.963406,-37.820959],[144.963332,-37.821167],[144.963433,-37.820848],[144.963195,-37.821174],[144.96369,-37.821029],[144.963787,-37.821185,31],[144.963545,-37.820936],[144.963849,-37.82114],[144.963217,-37.821112],[144.963393,-37.820931],[144.963342,-37.821121],[144.963404,-37.820869],[144.963347,-37.820984],[144.963877,-37.821203,31],[144.963164,-37.821004],[144.963774,-37.821221,31],[144.963827,-37.821032,31],[144.963862,-37.821137,31],[144.963663,-37.821045],[144.963958,-37.821221,31],[144.963178,-37.821292],[144.963161,-37.821112],[144.963406,-37.820888],[144.963954,-37.821128],[144.963267,-37.820725],[144.964029,-37.821247,31],[144.963464,-37.820959],[144.963745,-37.820951],[144.96376,-37.821065],[144.963497,-37.821003],[144.963233,-37.821146],[144.963815,-37.821188,31],[144.963218,-37.821151],[144.964095,-37.821284,31],[144.963395,-37.820908],[144.963218,-37.821099],[144.963489,-37.820903,31],[144.963358,-37.821132],[144.963882,-37.821066],[144.963698,-37.821005],[144.963411,-37.820962],[144.963806,-37.821045],[144.964042,-37.821284,9],[144.963604,-37.821164,9],[144.963825,-37.821164,31],[144.963695,-37.821417,-13],[144.963918,-37.821139],[144.963776,-37.821064,31],[144.963574,-37.82129,-13],[144.963653,-37.821378,-13],[144.9641,-37.821271,31],[144.964064,-37.821131],[144.963872,-37.821035],[144.963968,-37.821217,31],[144.963454,-37.820999],[144.964051,-37.821276,31],[144.963398,-37.82098],[144.963212,-37.821141],[144.963365,-37.820888],[144.963999,-37.821221,31],[144.963939,-37.821311,-14],[144.964189,-37.821208],[144.963714,-37.821488,-18],[144.964172,-37.821229,31],[144.96329,-37.820955],[144.963392,-37.820875],[144.963238,-37.821128],[144.963705,-37.821516,-19],[144.964083,-37.821263,31],[144.963741,-37.8211,31],[144.964107,-37.821297,31],[144.963643,-37.820966,33],[144.963757,-37.820934],[144.963779,-37.821206,31],[144.963806,-37.82108,31],[144.96321,-37.82112],[144.964106,-37.821297,31],[144.963306,-37.820842],[144.963787,-37.82092,70],[144.963861,-37.821148,31],[144.96329,-37.820985,30],[144.963863,-37.821196],[144.963926,-37.820953],[144.964004,-37.821185],[144.96369,-37.820738,30],[144.96353,-37.821039],[144.963655,-37.820846],[144.963667,-37.820955],[144.96321,-37.821092,7],[144.962978,-37.820906,8],[144.963181,-37.820658,23],[144.963844,-37.820495,18],[144.963339,-37.819162],[144.964229,-37.820297,16],[144.964545,-37.820286,15]]},"properties":{}}};

                mapboxgl.accessToken = 'pk.eyJ1IjoiYWFyb25zaW1zIiwiYSI6ImNqN2Z0NjVkYjExNHkyd28yNnc5cXhjNWgifQ.cgZZrzDKR2B8wX9TBXJ_kw';
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v9',
                    center: $scope.setup.lastPoint,
                    zoom: 15
                });

                map.on('load', function() {
                    map.addControl(new mapboxgl.NavigationControl());
                    map.addSource('theWalkLine', {
                        type: 'geojson',
                        data: $scope.setup.geoJsonLine
                    });

                    $scope.updateData = function(map) {

                        $http.get("setup.json?" + Math.random()).then(function(response) {
                            try {
                                $scope.setup = response.data;
                                $log.log("data loaded");
                                $scope.updateMapData(map);
                                $log.log("data updated");
                            } catch (error) {
                                $log.log("error loading data", error);
                            }

                        });

                    }



                    $scope.updateMapData = function(map) {
                        try {
                            if ($scope.TeamMarker) {
                                $scope.TeamMarker.remove();
                            }

                            map.getSource('theWalkLine').setData($scope.setup.geoJsonLine);
                            //map.getSource('theTeam').setData($scope.setup.geojsonTeamPoints);

                            var geojson = $scope.setup.geojsonTeamPoints;
                            geojson.features.forEach(function(marker) {
                                var el = document.createElement('div');
                                el.className = 'markerRT';
                                $scope.TeamMarker = new mapboxgl.Marker(el)
                                    .setLngLat(marker.geometry.coordinates)
                                    .addTo(map);
                            });
                            map.flyTo({
                                center: $scope.setup.lastPoint
                            });
                        } catch (error) {
                            $log.log("error updating data", error);
                        }
                    }
                    $scope.updateMapData(map)
                    map.addLayer({
                        "id": "route2",
                        "type": "line",
                        "source": 'theWalkLine',
                        "layout": {
                            "line-join": "round",
                            "line-cap": "round"
                        },
                        "paint": {
                            "line-color": "black",
                            "line-width": 7
                        }
                    });
                    map.addLayer({
                        "id": "route1",
                        "type": "line",
                        "source": 'theWalkLine',
                        "layout": {
                            "line-join": "round",
                            "line-cap": "round"
                        },
                        "paint": {
                            "line-color": "red",
                            "line-width": 2
                        }
                    });


                    addLine("section5", section5, '#898cff');
                    addLine("section6", section6, '#ffdc89');
                    addLine("section7", section7, '#f5a26f');
                    addLine("section8", section8, '#ed6d79');

                    /*    */
                    var finishLinePoint = {
                        "type": "FeatureCollection",
                        "features": [{
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [145.647024, -37.773042]
                            }
                        }]
                    };
                    finishLinePoint.features.forEach(function(marker) {
                        var el = document.createElement('div');
                        el.className = 'markerFinish';
                        new mapboxgl.Marker(el)
                            .setLngLat(marker.geometry.coordinates)
                            .addTo(map);
                    });



                    $scope.updateInterval = $interval(function() {
                        $scope.updateData(map);
                    }, 10000);


                    /*    */
                });

            });
    </script>
</body>

</html>
