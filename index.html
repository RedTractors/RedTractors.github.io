undefined<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Red Tractors-Oxfam 2018 </title>

    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.44.1/mapbox-gl.css' rel='stylesheet' />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.5/angular.min.js" integrity="sha256-zBy1l2WBAh2vPF8rnjFMUXujsfkKjya0Jy5j6yKj0+Q=" crossorigin="anonymous"></script>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <script src="lines.js"></script>


    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-104176150-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }
        gtag('js', new Date());

        gtag('config', 'UA-104176150-2');
    </script>


    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        h3 {
            margin-top: 0;
            margin-bottom: 4px;
        }
        
        h5 {
            margin-top: 0;
            margin-bottom: 0;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        .markerRT {
            background-image: url('redTractor.png');
            background-size: cover;
            width: 50px;
            height: 50px;
            xxborder-radius: 50%;
            cursor: pointer;
        }
        
        .markerFinish {
            background-image: url('finish.png');
            background-size: cover;
            width: 50px;
            height: 50px;
            xxborder-radius: 50%;
            cursor: pointer;
        }
        
        .distanceBox {
            position: absolute;
            bottom: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.562);
            z-index: 1000;
            padding: 10px;
        }
    </style>
</head>




<body ng-app="RedTractorsApp">
    <div ng-controller="RedTractorsController" class='distanceBox'>
        <div ng-hide="setup.setup.notReady">
            <h3> Distance: {{setup.setup.distance}} km</h3>
            <h3> WalkingTime: {{setup.setup.walktime}} </h3>
            <h3> Time Since Last Point: {{setup.setup.timeSinceLastCheckpointString}}</h3>
        </div>
        <div ng-show="setup.setup.notReady" style="color:orange">
            <h3> Not Started Yet</h3>
        </div>

        <h5> Data Updated: {{setup.setup.scriptLastRunAt}}</h5>
        </h1>
    </div>

    <div id='map'></div>



    <script>
        var map;

        var addLine = function(key, json, color) {
            map.addLayer({
                "id": key,
                "type": "line",
                "source": {
                    "type": "geojson",
                    "data": json
                },
                "layout": {
                    "line-join": "round",
                    "line-cap": "round"
                },
                "paint": {
                    "line-color": color,
                    "line-width": 10,
                    "line-opacity": .6,
                }
            });
        }

        angular.module('RedTractorsApp', [])
            .controller('RedTractorsController', function($scope, $http, $log, $interval) {

                $scope.setup = {"setup":{"notReady":true,"distance":null,"secondsFromLastPoint":null,"timeSinceLastCheckpoint":null,"timeSinceLastCheckpointString":null,"walktime":null,"scriptLastRunAt":"09:01:04"},"lastPoint":[145.406996,-37.824731],"geojsonTeamPoints":{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Point","coordinates":[145.406996,-37.824731]},"properties":{"name":"team","title":"team"}}]},"geoJsonLine":{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Point","coordinates":[145.406996,-37.824731]},"properties":{"name":"team","title":"team"}}]}};

                mapboxgl.accessToken = 'pk.eyJ1IjoiYWFyb25zaW1zIiwiYSI6ImNqN2Z0NjVkYjExNHkyd28yNnc5cXhjNWgifQ.cgZZrzDKR2B8wX9TBXJ_kw';
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v9',
                    center: $scope.setup.lastPoint,
                    zoom: 15
                });

                map.on('load', function() {
                    map.addControl(new mapboxgl.NavigationControl());
                    map.addSource('theWalkLine', {
                        type: 'geojson',
                        data: $scope.setup.geoJsonLine
                    });

                    $scope.updateData = function(map) {

                        $http.get("setup.json?" + Math.random()).then(function(response) {
                            try {
                                $scope.setup = response.data;
                                //$log.log("data loaded");
                                $scope.updateMapData(map);
                                //$log.log("data updated");
                            } catch (error) {
                                $log.log("error loading data", error);
                            }

                        });

                    }



                    $scope.updateMapData = function(map) {
                        try {
                            if ($scope.TeamMarker) {
                                $scope.TeamMarker.remove();
                            }

                            map.getSource('theWalkLine').setData($scope.setup.geoJsonLine);
                            //map.getSource('theTeam').setData($scope.setup.geojsonTeamPoints);

                            var geojson = $scope.setup.geojsonTeamPoints;
                            geojson.features.forEach(function(marker) {
                                var el = document.createElement('div');
                                el.className = 'markerRT';
                                $scope.TeamMarker = new mapboxgl.Marker(el)
                                    .setLngLat(marker.geometry.coordinates)
                                    .addTo(map);
                            });
                            map.flyTo({
                                center: $scope.setup.lastPoint
                            });
                        } catch (error) {
                            $log.log("error updating data", error);
                        }
                    }
                    $scope.updateMapData(map)
                    map.addLayer({
                        "id": "route2",
                        "type": "line",
                        "source": 'theWalkLine',
                        "layout": {
                            "line-join": "round",
                            "line-cap": "round"
                        },
                        "paint": {
                            "line-color": "black",
                            "line-width": 7
                        }
                    });
                    map.addLayer({
                        "id": "route1",
                        "type": "line",
                        "source": 'theWalkLine',
                        "layout": {
                            "line-join": "round",
                            "line-cap": "round"
                        },
                        "paint": {
                            "line-color": "red",
                            "line-width": 2
                        }
                    });


                    addLine("section5", section5, '#898cff');
                    addLine("section6", section6, '#ffdc89');
                    addLine("section7", section7, '#f5a26f');
                    addLine("section8", section8, '#ed6d79');

                    /*    */
                    var finishLinePoint = {
                        "type": "FeatureCollection",
                        "features": [{
                            "type": "Feature",
                            "geometry": {
                                "type": "Point",
                                "coordinates": [145.647024, -37.773042]
                            }
                        }]
                    };
                    finishLinePoint.features.forEach(function(marker) {
                        var el = document.createElement('div');
                        el.className = 'markerFinish';
                        new mapboxgl.Marker(el)
                            .setLngLat(marker.geometry.coordinates)
                            .addTo(map);
                    });



                    $scope.updateInterval = $interval(function() {
                        $scope.updateData(map);
                    }, 20000);


                    /*    */
                });

            });
    </script>
</body>

</html>
